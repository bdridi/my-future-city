var ne=Object.defineProperty;var oe=(a,e,r)=>e in a?ne(a,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[e]=r;var o=(a,e,r)=>(oe(a,typeof e!="symbol"?e+"":e,r),r);import{b0 as se,r as u,c as f}from"./index-b10c045f.js";class re{constructor(e,r,i,l){o(this,"name");o(this,"postCode");o(this,"level");o(this,"score");this.name=e,this.postCode=r,this.level=i,this.score=l}}class ae{constructor(e){o(this,"codeInsee");o(this,"codePostal");o(this,"codeRegion");o(this,"libelle");o(this,"indicators");o(this,"indicatorsScores",[]);this.codeInsee=e.codeInsee,this.codePostal=e.codePostal,this.codeRegion=e.codeRegion,this.libelle=e.libelle,this.indicators=new Map([["cambriolageLogement",e.cambriolageLogement],["partHlmResPrincipal",e.partHlmResPrincipal],["trafficStup",e.trafficStup],["medecinsGen",e.medecinsGen],["creches",e.creches],["ecolesElem",e.ecolesElem],["partMaisons",e.partMaisons],["violSex",e.violSex],["prixm2",e.prixm2],["creationEnt",e.creationEnt],["partLogSurOccup",e.partLogSurOccup]])}getGlobalScoreFor(e,r){const i=this.indicatorsScores.filter(l=>e.includes(l.code)&&Number.isFinite(l.score)).map(l=>l.score);if(console.log(`STRICT MODE => ${r}`),!r||ie(i,e)){const l=i.reduce((d,S)=>d+S,0);return Number((l/i.length).toFixed(1))}else return null}addIndicatorScore(e){this.indicatorsScores.push(e)}allSelectedIndicatorsPresent(e){for(const r of e){let i=this.indicators.get(r);if(!Number.isFinite(i))return!1}return!0}}function ie(a,e){return a.length==e.length}class le{constructor(e,r,i,l){o(this,"code");o(this,"name");o(this,"value");o(this,"score");this.code=e,this.name=r,this.score=l,this.value=i}}class ce{constructor(e){o(this,"code");o(this,"name");o(this,"source");o(this,"description");o(this,"year");o(this,"nationalReference");o(this,"formula");o(this,"scoreLevels");o(this,"order");this.code=e.code,this.name=e.name,this.description=e.description,this.year=e.year,this.nationalReference=e.nationalReference,this.formula=e.formula,this.scoreLevels=e.scales.map(r=>new v(r)),this.order=E[e.order]}getLevelFor(e){return this.scoreLevels.find(r=>r.includes(e))}}var E=(a=>(a[a.ASC=0]="ASC",a[a.DESC=1]="DESC",a))(E||{});class v{constructor(e){o(this,"name");o(this,"startValue");o(this,"stopValue");o(this,"color");this.name=e.name,this.startValue=e.startValue,this.stopValue=e.stopValue,e.color&&(this.color=e.color)}valueForRatio(e,r){let i=e*this.getDistance();return r==1?this.stopValue-i:this.startValue+i}getRatio(e){return(e-this.startValue)/this.getDistance()}includes(e){return e>=this.startValue&&e<=this.stopValue}getDistance(){return this.stopValue-this.startValue}}class ue{constructor(){o(this,"indicatorStrictMode",!1);o(this,"selectedRegionCode",null);o(this,"selectedIndicatorsCodes",[]);o(this,"visibleLevels",["A","B","C","D","E"])}getHash(){var e;return((e=this.selectedIndicatorsCodes)==null?void 0:e.join())+this.indicatorStrictMode+this.selectedRegionCode+this.visibleLevels.join()}isReadyForRendering(){return this.selectedIndicatorsCodes.length>0}}const ge=se("myCity",()=>{const a=u(),e=u(),r=u(),i=u(),l=u(!1),d=u(),S=u(),m=u([]),g=u(new ue),N=u(!1),p=u(),C=[new v({name:"E",startValue:0,stopValue:1.9,color:"#f51e09"}),new v({name:"D",startValue:2,stopValue:3.9,color:"#e68e33"}),new v({name:"C",startValue:4,stopValue:5.9,color:"#ffe599"}),new v({name:"B",startValue:6,stopValue:7.9,color:"#b6d7a8"}),new v({name:"A",startValue:8,stopValue:10,color:"#38761d"})],j=new Map([["84",[45.29681,4.66048]],["53",[48.202047,-2.932644]],["24",[47.499998,1.749997]],["94",[42.18809,9.06841]],["44",[48.48452,6.11304]],["32",[50.10246,2.72475]],["11",[48.8499198,2.6370411]],["28",[49.06777,.31385]],["75",[45.40394,.37562]],["76",[43.64879,2.34357]],["52",[47.65949,-.81861]],["93",[44.05806,6.06385]],["27",[47.05109,5.07406]]]),G=f(()=>j.get(a.value));function P(t){e.value=t,m.value=[],g.value.selectedIndicatorsCodes=t}async function x(t){await R(t),await B(t),g.value.selectedRegionCode=t,a.value=t}function $(t){l.value=t,g.value.indicatorStrictMode=t,console.log(`store.indicatorStrictMode => ${l}`)}async function R(t){console.log(`loadGeoJsonFor : Fetching data for region ${t}`);const s=await(await fetch(window.location+`/geojson/${t}.geojson`)).json();return console.log(s),S.value=s,S.value}async function B(t){console.log(`Loading cities for region => ${t}`);const c=(await(await fetch(window.location+"/stats/cities-2.json")).json()).filter(h=>h.codeRegion.toString()==t).map(h=>{const b=new ae(h);return b.indicators.forEach((te,L)=>{const M=r.value.find(w=>w.code==L);if(M){const w=ee(M,te);b.addIndicatorScore(w)}else console.log(`⚠️ Indicator ${L} not found in reference`)}),b});i.value=new Map(c.map(h=>[Number(h.codeInsee),h]))}function A(t){d.value=y(t);const n=S.value.features.find(s=>s.properties.code==t);p.value=Y(n.geometry.coordinates)}async function H(){console.log("Loading indicators ...");const n=await(await fetch(window.location+"/indicators/all.json")).json();r.value=n.map(s=>new ce(s))}function J(t){g.value.visibleLevels=t}function T(){m.value=[]}const I=f(()=>g.value.visibleLevels);function V(t){return I.value.includes(t)}const W=f(()=>g.value.getHash());function k(t){return i.value?[...i.value.values()].filter(n=>n.libelle.includes(t)):[]}function q(){return d.value?d.value.getGlobalScoreFor(e.value??[],l.value):null}function F(t){if(g.value.isReadyForRendering()){const n=y(t);if(n){const s=n.getGlobalScoreFor(e.value??[],l.value);if(!s||Number.isNaN(s))return null;const c=D(s);return c&&V(c==null?void 0:c.name)&&m.value.push(new re(n.libelle,n.codePostal,c==null?void 0:c.name,s)),c}else return console.log(`cannot find city ${t}`),null}else return null}function z(){return d?F(d.value.codeInsee):null}const K=f(()=>d.value),O=f(()=>l.value),Q=f(()=>{var t;return((t=r.value)==null?void 0:t.filter(n=>{var s;return(s=e.value)==null?void 0:s.includes(n.code)}))||[]}),U=f(()=>C),X=f(()=>p);f(()=>p);function Y(t){const n=[];return t[0].forEach(s=>{n.push([s[1],s[0]])}),n}function y(t){if(i){const n=i.value.get(Number(t));return n||null}return null}function Z(t,n){const s=t.getLevelFor(n),c=_((s==null?void 0:s.name)??""),h=(s==null?void 0:s.getRatio(n))??0;return c.valueForRatio(h,t.order)}function _(t){return C.find(n=>n.name==t)}function D(t){return C.find(n=>t>=n.startValue&&t<=n.stopValue)??null}function ee(t,n){const s=new le(t.code,t.name,n);if(Number.isFinite(n)){const c=Z(t,n);s.score=Number(c.toFixed(1))}return s}return{selectIndicators:P,selectRegion:x,loadIndicatorsRefrence:H,setIndicatorModeStrict:$,selectCity:A,selectedRegionCoordinates:G,selectedIndicatorsCodes:e,selectedRegionCode:a,allIndicators:r,cities:i,getSelectedCity:K,getStrictMode:O,getSelectedCityScoreForSelectedIndicators:q,getScoreLevelForCity:F,stateHash:W,getSelectedIndicators:Q,getScoreLevelForSelectedCity:z,getStandardScoreLevels:U,searchCity:k,loadGeoJsonByRegion:R,getCityCoordinates:X,selectedCityCoordinates:p,selectedCity:d,mapState:g,regionGeoJson:S,setVisibleLevels:J,getVisibleLevels:I,citiesScores:m,disableChange:N,clearCitiesScores:T,isSelectedLevel:V}});export{ge as u};
